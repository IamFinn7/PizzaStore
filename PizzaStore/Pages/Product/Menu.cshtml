@page
@model PizzaStore.Pages.Product.MenuModel
@{
    ViewData["Title"] = "Menu - Food Website";
    var isStaff = User.IsInRole("Staff");
    var isUser = User.IsInRole("Member");
    var categoryIdAfter = ViewData["SelectedCategoryId"];
    var cateName = ViewData["CategoryText"];
    var searchNameAfter = ViewData["SearchName"];
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="~/css/menu.css">
    <link rel="stylesheet" href="https://unpkg.com/boxicons@latest/css/boxicons.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Raleway:wght@100;200;300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>

    <section class="menu" id="menu" style="display: flex; width : 100%">
        <div class="menu-sidebar" style="width: 250px; padding: 20px; background-color: #f5f5f5; border-right: 1px solid #ddd;">
            <h4>Search Menu</h4>
            <form id="search-form" method="get" action="/Product/Menu">
                <div class="input-group" style="margin-bottom: 15px;">
                    <label for="search-name" style="display: block; margin-bottom: 5px; font-weight: bold;">Search by Name:</label>
                    @if (searchNameAfter != null)
                    {
                        <input value="@searchNameAfter" type="text" id="search-name" name="searchName" placeholder="Enter product name"
                               style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; ">
                    }else{
                        <input type="text" id="search-name" name="searchName" placeholder="Enter product name"
                               style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; ">
                    }
                </div>

                <div class="input-group" style="margin-bottom: 15px;">
                    <label for="search-category" style="display: block; margin-bottom: 5px; font-weight: bold;">Search by Category:</label>
                    <select id="search-category" name="categoryId"
                            style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                        <option value="">All Categories</option>
                        @if (categoryIdAfter != null)
                        {
                            <option value="@categoryIdAfter">@cateName</option>
                        }
                        @foreach (var category in ViewBag.CategoryID)
                        {
                            <option value="@category.Value">@category.Text</option>
                        }
                    </select>
                </div>

                <button type="submit" class="search-btn" style="width: 100%; padding: 10px; background-color: #ff5722; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    Search
                </button>
            </form>
        </div>

        <div class="menu-content" style="flex: 1; padding: 20px;">
            @if (isStaff)
            {
                <div class="createProduct" style="margin-bottom: 20px;">
                    <a href="/Staff/CreateProduct" class="createProductBtn" style="padding: 10px 20px; background-color: #4caf50; color: white; text-decoration: none; border-radius: 4px;">Create New Product</a>
                </div>
            }
            @foreach (var product in Model.Products)
            {
                <div class="menu-item" style="margin-bottom: 30px;">
                    <img src="@product.ProductImage" alt="@product.ProductName" style="width: 100px; height: auto;">
                    <div class="menu-text" style="margin-top: 10px;">
                        <h5 style="margin: 0; font-size: 1.2rem;">@product.ProductName</h5>
                        <h6 style="margin: 5px 0; font-size: 1rem;">@String.Format("${0:F2}", product.UnitPrice)</h6>
                    </div>
                    @if (isStaff)
                    {
                        <button class="edit-button" onclick="openEditPopup('@product.ProductID')" style="padding: 5px 10px; background-color: #ff9800; color: white; border: none; border-radius: 4px; cursor: pointer;">Edit</button>
                    }
                    else
                    {
                        <form method="post" asp-page-handler="AddToCart" id="form_@product.ProductID" data-ajax="true" data-ajax-method="post" data-ajax-mode="replace" data-ajax-update="#cart-response">
                            <div class="quantity-container" style="margin-top: 10px;">
                                <input type="number" name="quantity" id="quantity_@product.ProductID" min="1" value="1" class="quantity-input" style="width: 60px; padding: 5px; border: 1px solid #ccc; border-radius: 4px;">
                            </div>
                            <input type="hidden" name="productId" value="@product.ProductID">
                            <input type="hidden" id="availableQuantity_@product.ProductID" value="@product.QuantityPerUnit">
                            <div class="form-group" style="margin-top: 10px;">
                                <input type="submit" value="Add to Cart" class="add-to-cart" style="padding: 5px 10px; background-color: #4caf50; color: white; border: none; border-radius: 4px; cursor: pointer;" @(product.QuantityPerUnit < 1 ? "disabled" : "") />
                            </div>
                        </form>
                    }
                </div>
            }
        </div>
    </section>
    @{
        var prevDisabled = !Model.Products.HasPreviousPage ? "disabled" : "";
        var nextDisabled = !Model.Products.HasNextPage ? "disabled" : "";
        var totalPages = Model.Products.TotalPages;
    }

    <div class="pagination">
        <a asp-page="/Product/Menu"
           asp-route-pageIndex="@(Model.Products.PageIndex - 1)"
           class="btn btn-primary @prevDisabled">
            Previous
        </a>

        @for (int i = 1; i <= totalPages; i++)
        {
            <a asp-page="/Product/Menu"
               asp-route-pageIndex="@i"
               class="btn btn-secondary @(Model.Products.PageIndex == i ? "active" : "")">
                @i
            </a>
        }

        <a asp-page="/Product/Menu"
           asp-route-pageIndex="@(Model.Products.PageIndex + 1)"
           class="btn btn-primary @nextDisabled">
            Next
        </a>
    </div>


    <div id="edit-popup" class="popup" style="display: none;">
        <div class="popup-content">
            
            <span class="close" onclick="closeEditPopup()">&times;</span>
            <h2>Edit Pizza</h2>
            <form id="edit-form" method="post">
                <input type="hidden" id="productId" name="SelectedProduct.ProductID" />
                <div class="input-group">
                    <label for="productName">Name:</label>
                    <input type="text" id="productName" name="SelectedProduct.ProductName" required>
                </div>
                <div class="input-group">
                    <label for="productPrice">Price:</label>
                    <input type="number" id="productPrice" name="SelectedProduct.UnitPrice" step="0.01" required>
                </div>
                <div class="input-group">
                    <label for="productImage">Image URL:</label>
                    <input type="text" id="productImage" name="SelectedProduct.ProductImage" required>
                </div>
                <button type="submit">Save Changes</button>
            </form>
        </div>
    </div>

    <script>
        function openEditPopup(productId) {
            console.log("Fetching product with ID:", productId);
            fetch(`/Product/Menu?handler=Edit&productId=${productId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(product => {
                    document.getElementById('productId').value = product.productID;
                    document.getElementById('productName').value = product.productName;
                    document.getElementById('productPrice').value = product.unitPrice;
                    document.getElementById('productImage').value = product.productImage;

                    document.getElementById('edit-popup').style.display = 'block';
                    document.body.style.overflow = 'hidden';
                })
                .catch(error => {
                    console.error('Error fetching product:', error);
                    alert(`Unable to fetch product details. Please try again. Error: ${error.message}`);
                });
        }

        function closeEditPopup() {
            document.getElementById('edit-popup').style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        document.addEventListener('DOMContentLoaded', function () {
        const forms = document.querySelectorAll('form[asp-page-handler="AddToCart"]');

        forms.forEach(function (form) {
            form.addEventListener('submit', function (event) {
                const productId = form.id.split('_')[1];
                const enteredQuantity = parseInt(document.getElementById('quantity_' + productId).value, 10);
                const availableQuantity = parseInt(document.getElementById('availableQuantity_' + productId).value, 10);
                if (enteredQuantity > availableQuantity) {
                    showPopup("The entered quantity exceeds the available stock!");
                    event.preventDefault();
                }

                const addToCartButton = form.querySelector('.add-to-cart');
                if (availableQuantity < 1) {
                    addToCartButton.disabled = true;
                } else {
                    addToCartButton.disabled = false;
                }
            });
        });
    });

        document.addEventListener('DOMContentLoaded', function () {
            var categoryIdAfter = '@categoryIdAfter';

            if (categoryIdAfter) {
                var selectElement = document.getElementById('search-category');
                selectElement.value = categoryIdAfter; 
            }
        });
    </script>
</body>
</html>
